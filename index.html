<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог мебели</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .thumbnail {
            width: 200px;
            height: 200px;
            cursor: pointer;
            object-fit: cover;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            max-width: 90%;
            max-height: 90%;
            text-align: center;
            color: #fff;
        }
        .main-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        .thumbnail-gallery {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            overflow-x: auto;
        }
        .thumbnail-gallery img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .thumbnail-gallery img.active {
            border: 2px solid #007bff;
        }
        .arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            color: black;
            text-shadow: 0 0 5px white;
            cursor: pointer;
            user-select: none;
            z-index: 1001;
        }
        .arrow-left {
            left: -50px;
        }
        .arrow-right {
            right: -50px;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
        }
        .fullscreen-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
        .fullscreen-btn:hover {
            background-color: #0056b3;
        }
        .total-cost {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        .editable:hover {
            background-color: #f0f0f0;
        }
        .save-btn {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .save-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Каталог мебели</h1>
    <table id="furnitureTable">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
    <button class="save-btn" id="saveButton">Сохранить изменения</button>

    <!-- Модальное окно галереи -->
    <div id="galleryModal" class="modal">
        <span class="close">×</span>
        <div class="modal-content">
            <img id="mainImage" class="main-image" src="" alt="Main Image">
            <div class="thumbnail-gallery" id="thumbnailGallery"></div>
            <span class="arrow arrow-left" id="arrowLeft">◀</span>
            <span class="arrow arrow-right" id="arrowRight">▶</span>
            <button class="fullscreen-btn" id="fullscreenBtn">Полноэкранный режим</button>
        </div>
    </div>

    <script>

 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDyLLgQeRNghUjsCF4aGnwVvrvPfuwf0r8",
  authDomain: "furniture-catalog-35e3e.firebaseapp.com",
  projectId: "furniture-catalog-35e3e",
  storageBucket: "furniture-catalog-35e3e.firebasestorage.app",
  messagingSenderId: "705330640295",
  appId: "1:705330640295:web:055306fbfc3f95c36cb282",
  measurementId: "G-98YM4XPHN7"
};

	// Initialize Firebase
	const app = initializeApp(firebaseConfig);
	const analytics = getAnalytics(app);

        document.addEventListener('DOMContentLoaded', async () => {
            const table = document.getElementById('furnitureTable');
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            const tfoot = document.getElementById('tableFooter');
            const saveButton = document.getElementById('saveButton');
            const modal = document.getElementById('galleryModal');
            const mainImage = document.getElementById('mainImage');
            const thumbnailGallery = document.getElementById('thumbnailGallery');
            const closeBtn = document.querySelector('.close');
            const arrowLeft = document.getElementById('arrowLeft');
            const arrowRight = document.getElementById('arrowRight');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            let currentIndex = 0;
            let images = [];

            // Загрузка furniture_catalog.json
            let furnitureData = [];
            try {
                const response = await fetch('furniture_catalog.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                furnitureData = await response.json();
            } catch (error) {
                console.error('Ошибка загрузки furniture_catalog.json:', error);
                return;
            }

            // Загрузка images.json (для галереи)
            let imageData = {};
            try {
                const response = await fetch('images.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                imageData = await response.json();
            } catch (error) {
                console.error('Ошибка загрузки images.json:', error);
                return;
            }

            // Динамическое создание заголовков
            const headers = Object.keys(furnitureData[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Заполнение таблицы данными
            let totalCost = 0;
            furnitureData.forEach((item, rowIndex) => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    if (header === 'data-prefix') {
                        const img = document.createElement('img');
                        img.className = 'thumbnail';
                        img.setAttribute('data-prefix', item[header]);
                        img.setAttribute('loading', 'lazy');
                        img.setAttribute('alt', item['Название']);
                        const imageList = imageData[item[header]] || [];
                        img.src = imageList.length > 0 ? imageList[0] : 'img/placeholder.webp';
                        td.appendChild(img);
                    } else if (header === 'Оценка (агент TwoTables), за 1 шт.') {
                        const cost = item[header];
                        td.textContent = cost > 0 ? cost.toLocaleString('ru-RU') + ' ₽' : '';
                        td.style.textAlign = 'right';
                        const quantity = parseInt(item['Количество, шт.']) || 1;
                        totalCost += cost * quantity;
                    } else if (header === 'Пользовательская оценка') {
                        td.className = 'editable';
                        td.setAttribute('contenteditable', 'true');
                        td.textContent = item[header] || '';
                        td.style.textAlign = 'right';
                        td.addEventListener('input', (e) => {
                            furnitureData[rowIndex][header] = e.target.textContent;
                        });
                    } else {
                        td.textContent = item[header] || '';
                        if (header === '№' || header === 'Количество, шт.') {
                            td.style.textAlign = 'right';
                        }
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });

            // Добавление итоговой строки
            const totalRow = document.createElement('tr');
            const totalLabelCell = document.createElement('td');
            totalLabelCell.colSpan = headers.length - 1;
            totalLabelCell.textContent = 'Итоговая стоимость (агент TwoTables):';
            totalLabelCell.style.textAlign = 'right';
            totalLabelCell.classList.add('total-cost');
            const totalValueCell = document.createElement('td');
            totalValueCell.textContent = totalCost.toLocaleString('ru-RU') + ' ₽';
            totalValueCell.style.textAlign = 'right';
            totalValueCell.classList.add('total-cost');
            totalRow.appendChild(totalLabelCell);
            totalRow.appendChild(totalValueCell);
            tfoot.appendChild(totalRow);

            // Сохранение изменений
saveButton.addEventListener('click', async () => {
    try {
        await db.collection('furniture').doc('catalog').set({ data: furnitureData });
        alert('Данные сохранены в Firebase!');
    } catch (error) {
        console.error('Ошибка сохранения:', error);
        alert('Ошибка при сохранении данных. Данные будут выведены в консоль.');
        console.log(JSON.stringify(furnitureData, null, 2));
    }
});

            // Код для галереи
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumbnail => {
                const prefix = thumbnail.getAttribute('data-prefix');
                const imageList = imageData[prefix];
                if (imageList && imageList.length > 0) {
                    thumbnail.src = imageList[0];
                } else {
                    thumbnail.src = 'img/placeholder.webp';
                }
            });

            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', () => {
                    const prefix = thumbnail.getAttribute('data-prefix');
                    images = imageData[prefix] || [];
                    if (images.length === 0) return;
                    currentIndex = 0;
                    updateGallery();
                    modal.style.display = 'flex';
                });
            });

            function updateGallery() {
                mainImage.src = images[currentIndex];
                thumbnailGallery.innerHTML = '';
                images.forEach((imgSrc, index) => {
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    if (index === currentIndex) {
                        img.classList.add('active');
                    }
                    img.addEventListener('click', () => {
                        currentIndex = index;
                        updateGallery();
                    });
                    thumbnailGallery.appendChild(img);
                });
                arrowLeft.style.display = images.length > 1 && currentIndex > 0 ? 'block' : 'none';
                arrowRight.style.display = images.length > 1 && currentIndex < images.length - 1 ? 'block' : 'none';
            }

            arrowLeft.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateGallery();
                }
            });

            arrowRight.addEventListener('click', () => {
                if (currentIndex < images.length - 1) {
                    currentIndex++;
                    updateGallery();
                }
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            fullscreenBtn.addEventListener('click', () => {
                if (mainImage.requestFullscreen) {
                    mainImage.requestFullscreen();
                } else if (mainImage.mozRequestFullScreen) {
                    mainImage.mozRequestFullScreen();
                } else if (mainImage.webkitRequestFullscreen) {
                    mainImage.webkitRequestFullscreen();
                } else if (mainImage.msRequestFullscreen) {
                    mainImage.msRequestFullscreen();
                }
            });
        });
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'91cad95afc5cbcfe',t:'MTc0MTM1ODQzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>