<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com; object-src 'none';">
    <title>Каталог мебели</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .thumbnail {
            width: 200px;
            height: 200px;
            cursor: pointer;
            object-fit: cover;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            max-width: 90%;
            max-height: 90%;
            text-align: center;
            color: #fff;
        }
        .main-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        .thumbnail-gallery {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            overflow-x: auto;
        }
        .thumbnail-gallery img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .thumbnail-gallery img.active {
            border: 2px solid #007bff;
        }
        .arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            color: black;
            text-shadow: 0 0 5px white;
            cursor: pointer;
            user-select: none;
            z-index: 1001;
        }
        .arrow-left {
            left: -50px;
        }
        .arrow-right {
            right: -50px;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
        }
        .fullscreen-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
        .fullscreen-btn:hover {
            background-color: #0056b3;
        }
        .total-cost {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        .editable {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
            min-height: 24px;
            padding: 2px 4px;
        }
        .editable:hover {
            background-color: #f0f0f0;
        }
        .editable:empty:before {
            content: 'Предложите стоимость предмета';
            color: #6c757d;
            font-style: italic;
        }
        .save-btn {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .save-btn:hover {
            background-color: #218838;
        }
        .floating-save {
            position: fixed;
            bottom: 20px;
            right: 20px;
            text-align: center;
            z-index: 1000;
        }
        .save-note {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            max-width: 200px;
        }
    </style>
    <!-- Подключение Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js" type="module"></script>
</head>
<body>
    <h1>Каталог мебели</h1>
    <table id="furnitureTable">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFooter"></tfoot>
    </table>
    <div class="floating-save">
        <button class="save-btn" id="saveButton">Сохранить</button>
        <p class="save-note">Предложите Вашу цену на интересующие вас предметы и нажмите Сохранить</p>
    </div>

    <!-- Модальное окно галереи -->
    <div id="galleryModal" class="modal">
        <span class="close">×</span>
        <div class="modal-content">
            <img id="mainImage" class="main-image" src="" alt="Main Image">
            <div class="thumbnail-gallery" id="thumbnailGallery"></div>
            <span class="arrow arrow-left" id="arrowLeft">◀</span>
            <span class="arrow arrow-right" id="arrowRight">▶</span>
            <button class="fullscreen-btn" id="fullscreenBtn">Полноэкранный режим</button>
        </div>
    </div>

    <!-- Модальное окно для ввода имени и телефона -->
    <div id="userInfoModal" class="modal">
        <div class="modal-content" style="background-color: #fff; color: #000; max-width: 400px;">
            <span class="close">×</span>
            <h2>Введите ваши данные</h2>
            <form id="userInfoForm">
                <label for="userName">Имя (обязательно):</label><br>
                <input type="text" id="userName" name="userName" autocomplete="name" required style="width: 100%; padding: 8px; margin: 8px 0;"><br>
                <label for="userPhone">Телефон (необязательно):</label><br>
                <input type="tel" id="userPhone" name="userPhone" autocomplete="tel" style="width: 100%; padding: 8px; margin: 8px 0;"><br>
                <button type="submit" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px;">Отправить</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Импорт Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Конфигурация Firebase (замените на вашу)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "furniture-catalog.firebaseapp.com",
            projectId: "furniture-catalog",
            storageBucket: "furniture-catalog.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', async () => {
            const table = document.getElementById('furnitureTable');
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            const tfoot = document.getElementById('tableFooter');
            const saveButton = document.getElementById('saveButton');
            const modal = document.getElementById('galleryModal');
            const mainImage = document.getElementById('mainImage');
            const thumbnailGallery = document.getElementById('thumbnailGallery');
            const closeBtn = document.querySelector('.close');
            const arrowLeft = document.getElementById('arrowLeft');
            const arrowRight = document.getElementById('arrowRight');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const userInfoModal = document.getElementById('userInfoModal');
            const userInfoForm = document.getElementById('userInfoForm');
            const userInfoCloseBtn = userInfoModal.querySelector('.close');
            let currentIndex = 0;
            let images = [];

            // Загрузка furniture_catalog.json
            let furnitureData = [];
            try {
                const response = await fetch('furniture_catalog.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                furnitureData = await response.json();
            } catch (error) {
                console.error('Ошибка загрузки furniture_catalog.json:', error);
                return;
            }

            // Загрузка images.json (для галереи)
            let imageData = {};
            try {
                const response = await fetch('images.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                imageData = await response.json();
            } catch (error) {
                console.error('Ошибка загрузки images.json:', error);
                return;
            }

            // Динамическое создание заголовков
            const headers = Object.keys(furnitureData[0]).filter(header => header !== 'data-prefix');
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Заполнение таблицы данными
            let totalCost = 0;
            furnitureData.forEach((item, rowIndex) => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    if (header === 'Фото') {
                        const prefix = item['data-prefix'] || `item${item['№№']}`;
                        const img = document.createElement('img');
                        img.className = 'thumbnail';
                        img.setAttribute('data-prefix', prefix);
                        img.setAttribute('loading', 'lazy');
                        img.setAttribute('alt', item['Название'] || 'Изображение');
                        const imageList = imageData[prefix] || [];
                        img.src = imageList.length > 0 ? imageList[0] : 'img/placeholder.webp';
                        td.appendChild(img);
                    } else if (header === 'Оценка (агент TwoTables), за 1 шт.') {
                        const cost = item[header];
                        td.textContent = cost > 0 ? cost.toLocaleString('ru-RU') + ' ₽' : '';
                        td.style.textAlign = 'right';
                        const quantity = parseInt(item['Количество, шт.']) || 1;
                        totalCost += cost * quantity;
                    } else if (header === 'Пользовательская оценка') {
                        td.className = 'editable';
                        td.setAttribute('contenteditable', 'true');
                        td.textContent = item[header] || '';
                        td.style.textAlign = 'right';
                        td.addEventListener('input', (e) => {
                            furnitureData[rowIndex][header] = e.target.textContent;
                        });
                    } else {
                        td.textContent = item[header] || '';
                        if (header === '№№' || header === 'Количество, шт.') {
                            td.style.textAlign = 'right';
                        }
                    }
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });

            // Добавление итоговой строки
            const totalRow = document.createElement('tr');
            const totalLabelCell = document.createElement('td');
            totalLabelCell.colSpan = headers.length - 1;
            totalLabelCell.textContent = 'Итоговая стоимость (агент TwoTables):';
            totalLabelCell.style.textAlign = 'right';
            totalLabelCell.classList.add('total-cost');
            const totalValueCell = document.createElement('td');
            totalValueCell.textContent = totalCost.toLocaleString('ru-RU') + ' ₽';
            totalValueCell.style.textAlign = 'right';
            totalValueCell.classList.add('total-cost');
            totalRow.appendChild(totalLabelCell);
            totalValueCell.appendChild(totalValueCell);
            tfoot.appendChild(totalRow);

            // Открытие модального окна для ввода данных пользователя
            saveButton.addEventListener('click', () => {
                userInfoModal.style.display = 'flex';
            });

            // Сохранение данных после ввода имени и телефона
            userInfoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userName = document.getElementById('userName').value.trim();
                const userPhone = document.getElementById('userPhone').value.trim();
                if (!userName) {
                    alert('Пожалуйста, введите ваше имя.');
                    return;
                }
                try {
                    const submissionData = {
                        userName: userName,
                        userPhone: userPhone,
                        data: furnitureData,
                        timestamp: new Date().toISOString()
                    };
                    await setDoc(doc(db, 'furniture', `submission_${Date.now()}`), submissionData);
                    alert('Данные успешно сохранены!');
                    userInfoModal.style.display = 'none';
                    userInfoForm.reset();
                } catch (error) {
                    console.error('Ошибка сохранения:', error);
                    alert('Ошибка при сохранении данных. Данные выведены в консоль.');
                    console.log(JSON.stringify({ userName, userPhone, data: furnitureData }, null, 2));
                }
            });

            userInfoCloseBtn.addEventListener('click', () => {
                userInfoModal.style.display = 'none';
            });

            userInfoModal.addEventListener('click', (e) => {
                if (e.target === userInfoModal) {
                    userInfoModal.style.display = 'none';
                }
            });

            // Код для галереи
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumbnail => {
                const prefix = thumbnail.getAttribute('data-prefix');
                const imageList = imageData[prefix] || [];
                if (imageList && imageList.length > 0) {
                    thumbnail.src = imageList[0];
                } else {
                    thumbnail.src = 'img/placeholder.webp';
                }
            });

            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', () => {
                    const prefix = thumbnail.getAttribute('data-prefix');
                    images = imageData[prefix] || [];
                    if (images.length === 0) return;
                    currentIndex = 0;
                    updateGallery();
                    modal.style.display = 'flex';
                });
            });

            function updateGallery() {
                mainImage.src = images[currentIndex];
                thumbnailGallery.innerHTML = '';
                images.forEach((imgSrc, index) => {
                    const img = document.createElement('img');
                    img.src = imgSrc;
                    if (index === currentIndex) {
                        img.classList.add('active');
                    }
                    img.addEventListener('click', () => {
                        currentIndex = index;
                        updateGallery();
                    });
                    thumbnailGallery.appendChild(img);
                });
                arrowLeft.style.display = images.length > 1 && currentIndex > 0 ? 'block' : 'none';
                arrowRight.style.display = images.length > 1 && currentIndex < images.length - 1 ? 'block' : 'none';
            }

            arrowLeft.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateGallery();
                }
            });

            arrowRight.addEventListener('click', () => {
                if (currentIndex < images.length - 1) {
                    currentIndex++;
                    updateGallery();
                }
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            fullscreenBtn.addEventListener('click', () => {
                if (mainImage.requestFullscreen) {
                    mainImage.requestFullscreen();
                } else if (mainImage.mozRequestFullScreen) {
                    mainImage.mozRequestFullScreen();
                } else if (mainImage.webkitRequestFullscreen) {
                    mainImage.webkitRequestFullscreen();
                } else if (mainImage.msRequestFullscreen) {
                    mainImage.msRequestFullscreen();
                }
            });
        });
    </script>
</body>
</html>
